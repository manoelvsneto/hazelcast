# Runtime Dockerfile para JAR pré-compilado ARM64
# Este Dockerfile assume que o JAR já foi compilado e está no contexto de build

FROM --platform=linux/arm64 eclipse-temurin:17-jre

WORKDIR /app

# Install required packages and create user
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    curl \
    procps && \
    rm -rf /var/lib/apt/lists/* && \
    groupadd -r hazelcast && \
    useradd -r -g hazelcast hazelcast

# Create logs directory
RUN mkdir -p /app/logs && \
    chown -R hazelcast:hazelcast /app

# Copy JAR from build artifacts (shaded JAR com todas as dependências)
COPY target/hazelcast-project-*.jar app.jar

# Set user
USER hazelcast

# Health check (opcional - requer endpoint /health na aplicação)
# HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
#     CMD curl -f http://localhost:8080/health || exit 1

# Expose port
EXPOSE 8080

# Environment variables
ENV JAVA_OPTS="-Xmx512m -Xms256m -Dhazelcast.logging.type=slf4j"

# Run application with JAVA_OPTS
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
